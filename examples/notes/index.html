<!DOCTYPE html>
<html>
  <head>
    <title>Notes</title>
    <link href='http://fonts.googleapis.com/css?family=Molengo&subset=latin' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Reenie+Beanie&subset=latin' rel='stylesheet' type='text/css'>
    <style>
      html {
        height: 100%;
      }

      body {
        height: 100%;
        font-family: sans-serif;
        margin: 0;
      }

      #main {
        display: none;
        height: 100%;
        width: 100%;
      }

      #header {
        background: #505455;
        border-bottom: 1px solid #ccf;
        display: block;
        height: 48px;
        line-height: 48px;
        width: 100%;
      }

      #header a {
        color: #fff;
      }

      #toolbar {
        float: right;
        margin-right: 0.5em;
      }


      #header h1, #header h2 {
        display: inline-block;
        margin: 0;
      }

      #header h1 {
        color: #eee;
        font-family: 'Reenie Beanie';
        font-size: 32px;
        margin: 0 10px;
        text-transform: uppercase;
      }

      #header h2:before {
        content: '(';
      }

      #header h2:after {
        content: ')';
      }

      #header h2 {
        color: #ddd;
        font-family: molengo;
        font-size: 14px;
      }

      #contents {
        padding: 0;
        top: 48px;
        bottom: 0;
        list-style: none;
        margin: 0;
        overflow-x: hidden;
        overflow-y: scroll;
        position: fixed;
        width: 200px;
      }

      #contents a {
        color: #333;
        display: inline-block;
        padding: 0.125em;
        text-decoration: none;
        width: 100%;
      }

      #contents a:hover {
        background: #eeeeee;
        background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#ffffff), to(#eeeeee));
      }

      #contents li.selected a {
        background: #70a5db;
        background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#70a5db), to(#2d6eba));
        border-top: #5a94d1;
        border-bottom: #2769b7;
        color: #fff;
        font-weight: bold;
      }

      #text {
        border: 0;
        font-family: 'reenie beanie', sans-serif;
        font-size: 30px;
        position: fixed;
        left: 200px;
        top: 48px;
        bottom: 35px;
        padding: 10px;
        right: 0;
      }

      #text:focus {
        outline: none;
      }
    </style>
  </head>

  <body>
    <div id="login_container">
      <input type="password" id="password" />
      <input type="button" id="login_button" value="Log in" />
    </div>

    <div id="main">
      <div id="header">
        <h1>Notes</h1>
        <h2>An <a href="http://openkeyval.org/">OpenKeyval.org</a> sample project</h2>

        <div id="toolbar">
          <input type="button" id="new_note" value="New note" />
          <input type="button" id="delete_note" value="Delete note" />
          <input type="button" id="save_note" value="Save note" />
        </div>
      </div>

      <ul id="contents"></ul>

      <textarea id="text"></textarea>
    </div>
  </body>

  <script src="../../www/statics/openkeyval.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
  <script src="aes.js"></script>
  <script src="sha1.js"></script>

  <script>

    var OKVNotes = {
      notes: {},
      noteTitles: null,
      password: null,

      exists: function(title) {
        return OKVNotes.noteTitles.indexOf(title) >= 0;
      },

      get: function(title, callback) {
        if(OKVNotes.notes[title]) {
          return callback(title, OKVNotes.notes[title]);
        }

        console.log('Fetching note:', title);
        window.remoteStorage.getItem(NotesApp.key('note:' + title), function(data) {
          OKVNotes.notes[title] = data ? JSON.parse(data).data : '';
          callback(title, OKVNotes.notes[title]);
        });
      },

      index: function(callback) {
        if(OKVNotes.notesTitles) {
          return callback(OKVNotes.notes);
        }

        console.log('Fetching note list');
        window.remoteStorage.getItem(NotesApp.key('notes'), function(data) {
          console.log(data);
          OKVNotes.noteTitles = data ? JSON.parse(data).sort() : [];
          console.log(OKVNotes.noteTitles);
          callback(OKVNotes.noteTitles);
        });
      },

      remove: function(title, callback) {
        OKVNotes.set(title, null, function() {
          delete OKVNotes.notes[title];
          console.log('Removing ' + title);
          var i = OKVNotes.noteTitles.indexOf(title);
          OKVNotes.noteTitles.remove(i);
          OKVNotes.saveIndex();

          callback.apply(arguments);
        });
      },

      saveIndex: function() {
        window.remoteStorage.setItem(NotesApp.key('notes'), JSON.stringify(OKVNotes.noteTitles));
      },

      set: function(title, data, callback) {
        if(title !== null && OKVNotes.noteTitles.indexOf(title) < 0) {
          OKVNotes.noteTitles.push(title);
          OKVNotes.saveIndex();
        }
        OKVNotes.notes[title] = data;
        var data = { title: title, data: data };
        console.log('Saving ', data, ' to ', title);
        window.remoteStorage.setItem(NotesApp.key('note:' + title), JSON.stringify(data), callback);
      }
    };

    var NotesApp = {
      currentNote: null,

      didReceiveNote: function(data) {
        var note = JSON.parse(data);
        console.log(note);
        NotesApp.noteData[note.name] = note.data;
        NotesApp.displayNote(note.name);
      },

      selectNote: function(title) {
        NotesApp.currentNote = title;
        if(title === null) {
          NotesApp.displayNote(null, '')
        } else {
          $('#text').attr('disabled', false).val('');
          OKVNotes.get(title, NotesApp.displayNote);
        }
      },

      didReceiveNotesList: function(noteTitles) {
        console.log('got muh note titles');
        console.log(noteTitles);
        if(noteTitles.length > 0) {
          //  Select the first note
          NotesApp.selectNote(noteTitles[0]);
        }

        NotesApp.refreshNotesList();
        $('#main').show();
      },

      refreshNotesList: function() {
        console.log('Current note is', NotesApp.currentNote);
        $('#contents').html('');
        $(OKVNotes.noteTitles).each(function(i, value) {
          var link = $('<a>').html(value).attr('href', '#');
          var item = $('<li />').html(link);
          if(value === NotesApp.currentNote) {
            item.addClass('selected');
          }

          item.appendTo($('#contents'));
        });
      },

      storeNotesList: function() {
        window.remoteStorage.setItem(NotesApp.key('notes'), JSON.stringify($.unique(NotesApp.notes).sort()));
      },

      key: function(key) {
        return 'openkeyvalnotes-' + SHA1(NotesApp.password + key);
      },

      init: function() {
        $('#login_button').click(NotesApp.onLoginButtonClick);
        $('#new_note').click(NotesApp.onNewNoteClick);
        $('#delete_note').click(NotesApp.onDeleteNoteClick);
        $('#save_note').click(NotesApp.onSaveNoteClick);
        $('#contents').click(NotesApp.onNoteClick);

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
          var rest = this.slice((to || from) + 1 || this.length);
          this.length = from < 0 ? this.length + from : from;
          return this.push.apply(this, rest);
        };

        NotesApp.password = 'test';
        NotesApp.onLoginButtonClick();
      },

      onDeleteNoteClick: function(e) {
        if(!confirm("Are you sure you want to remove '" + NotesApp.currentNote + "'? This can't be undone.")) {
          return;
        }

        OKVNotes.remove(NotesApp.currentNote, function() {
          NotesApp.selectNote((OKVNotes.noteTitles.length > 0) ? OKVNotes.noteTitles[0] : null);
          NotesApp.refreshNotesList();
        });
      },

      onSaveNoteClick: function(e) {
        console.log('Saving', NotesApp.currentNote);
        OKVNotes.set(NotesApp.currentNote, $('#text').val(), function() {
          console.log('Save done', arguments);
          $(e.target).attr('disabled', false);
        });
      },

      onLoginButtonClick: function() {
        $('#login_container').hide();
        NotesApp.password = $('#password').val();
        NotesApp.fetchNotesList();
      },

      onNewNoteClick: function() {
        var title = prompt('Create a new note called:').trim();
        if(!title) {
          return;
        }

        if(!OKVNotes.exists(title)) {
          //  Note doesn't exist; create it
          OKVNotes.set(title, "This is a new note called '" + title + "'", function() {
            NotesApp.selectNote(title);
            NotesApp.refreshNotesList();
          });
        }
      },

      onNoteClick: function(e) {
        if(e.target.tagName.toLowerCase() !== 'a') {
          return;
        }

        e.preventDefault();
        console.log(e.target);

        $('#contents .selected').removeClass('selected');
        $(e.target).parent().addClass('selected');

        var title = e.target.innerText;
        $('#text').html('');
        $('#text').attr('disabled', true);

        OKVNotes.get(title, NotesApp.displayNote);
      },

      fetchNotesList: function() {
        OKVNotes.index(NotesApp.didReceiveNotesList);
      },

      displayNote: function(title, data) {
        NotesApp.currentNote = title;
        console.log(title);
        console.log(data);
        $('#text').attr('disabled', false);
        $('#text').html(data);
      },
    };
    $(document).ready(NotesApp.init);
  </script>
</html>